<!DOCTYPE html>
<body>
  <style>
    canvas {
      border: 1px solid gray;
      transform: scale(2);
      transform-origin: top left;
    }
  </style>
  <button id="stop">stop</button>
  <canvas width="160" height="144"></canvas>
  <script src="binjgb.js"></script>
  <script>
    var canvasEl = document.querySelector('canvas');
    var canvasCtx = canvasEl.getContext('2d');
    var imageData = canvasCtx.createImageData(canvasEl.width, canvasEl.height);
    var audioCtx = new AudioContext();

    var buttonEl = document.querySelector('button');
    buttonEl.addEventListener('click', function() {
      stop = true;
    });
    var stop = false;

    function get(url, callback) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.responseType = 'arraybuffer';
      xhr.onload = function(e) {
        if (xhr.status == 200) {
          callback(xhr.response);
        } else {
          callback(null);
        }
      };
      xhr.onerror = function(e) {
          callback(null);
      };
      xhr.send(null);
    }

    var romData = 0, romSize = 0;

    get('dk.gb', function(src) {
      romData = _malloc(src.byteLength);
      romSize = src.byteLength;
      HEAPU8.set(new Uint8Array(src), romData, romSize);
      start();
    });

    var audioBufferSize = 1024;
    var e = 0;
    var frameBuffer = null;
    var audioBuffer = null;
    function start() {
      e = _new_emulator();
      _init_rom_data(e, romData, romSize);
      _init_audio_buffer(e, audioCtx.sampleRate, audioBufferSize * 2);
      var result = _init_emulator(e);
      frameBuffer = new Uint8Array(Module.buffer, _get_frame_buffer_ptr(e),
                                   _get_frame_buffer_size(e));
      audioBuffer = new Uint8Array(Module.buffer, _get_audio_buffer_ptr(e),
                                   _get_audio_buffer_capacity(e));

      requestAnimationFrame(renderVideo);
    };

    var CPU_CYCLES_PER_SECOND = 4194304;
    var CPU_CYCLES_PER_MS = CPU_CYCLES_PER_SECOND / 1000;
    var NEW_FRAME = 1;
    var AUDIO_BUFFER_FULL = 2;

    var lastMs = 0;
    var syncAudioSec = 0;
    var syncAudioCycles = 0;
    function renderVideo(nowMs) {
      if (!stop) requestAnimationFrame(renderVideo);
      var deltaMs = nowMs - (lastMs || nowMs);
      var deltaCycles = deltaMs * CPU_CYCLES_PER_MS;

      if (!syncAudioSec) syncAudioSec = audioCtx.currentTime;

      var runUntilCycles = _get_cycles(e) + deltaCycles;
      while (_get_cycles(e) < runUntilCycles) {
        var ev = _run_emulator_until_event(e, audioBufferSize << 1);
        if (ev & NEW_FRAME) {
          imageData.data.set(frameBuffer);
          canvasCtx.putImageData(imageData, 0, 0);
        }
        if (ev & AUDIO_BUFFER_FULL) {
          var inSamples = _get_audio_buffer_size(e) >> 1;
          var buffer =
              audioCtx.createBuffer(2, inSamples, audioCtx.sampleRate);
          var channel0 = buffer.getChannelData(0);
          var channel1 = buffer.getChannelData(1);
          var outPos = 0;
          var inPos = 0;
          for (var i = 0; i < inSamples; i++) {
            channel0[outPos] = (audioBuffer[inPos] - 128) / 128;
            channel1[outPos] = (audioBuffer[inPos+1] - 128) / 128;
            outPos++;
            inPos += 2;
          }
          var bufferSource = audioCtx.createBufferSource();
          bufferSource.buffer = buffer;
          bufferSource.connect(audioCtx.destination);
          bufferSource.start(syncAudioSec);
          var deltaGbSec =
              (_get_cycles(e) - syncAudioCycles) / CPU_CYCLES_PER_SECOND;
          syncAudioSec += deltaGbSec;
          syncAudioCycles = _get_cycles(e);
        }
      }

      lastMs = nowMs;
    }
  </script>
</body>
